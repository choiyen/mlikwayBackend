name: ë°°í¬

on:
  push:
    branches: ["master"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: â˜• JDK 17 ì„¤ì •
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"

      - name: ğŸ›  Gradle Wrapper ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: âš™ï¸ Gradle ë¹Œë“œ ì‹¤í–‰
        run: ./gradlew build --info --stacktrace

      - name: ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ì‹œ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: build/reports/tests/test

      - name: ğŸ” ë„ì»¤í—ˆë¸Œ ë¡œê·¸ì¸
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USER_NAME }}
          password: ${{ secrets.DOCKER_USER_PW }}

      - name: ğŸ§± ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ
        run: docker build -t ${{ secrets.DOCKER_USER_NAME }}/${{ secrets.DOCKER_IMAGE_NAME }} --no-cache .

      - name: ğŸ“¤ ë„ì»¤ ì´ë¯¸ì§€ í‘¸ì‹œ
        run: docker push ${{ secrets.DOCKER_USER_NAME }}/${{ secrets.DOCKER_IMAGE_NAME }}

      - name: ğŸš€ EC2ì— SSH ì ‘ì† í›„ ë°°í¬
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_IP }}
          port: 22
          username: ubuntu
          key: ${{ secrets.AWS_KEY }}
          script: |
            echo "${{ secrets.DOCKER_USER_PW }}" | docker login -u "${{ secrets.DOCKER_USER_NAME }}" --password-stdin

            cd ~/mlikyway

            cat <<EOF > .env
SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}
SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}
SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}
SPRING_SECURITY_USER=${{ secrets.SPRING_SECURITY_USER }}
SPRING_SECURITY_PASSWORD=${{ secrets.SPRING_SECURITY_PASSWORD }}
SPRING_SECURITY_ENCRYPT_KEY=${{ secrets.SPRING_SECURITY_ENCRYPT_KEY }}
SPRING_CREDENTIALS_ACCESSKEY=${{ secrets.SPRING_CREDENTIALS_ACCESSKEY }}
SPRING_CREDENTIALS_SECRETKEY=${{ secrets.SPRING_CREDENTIALS_SECRETKEY }}
SPRING_CREDENTIALS_BUCKETNAME=${{ secrets.SPRING_CREDENTIALS_BUCKETNAME }}
SPRING_SECRET_URL=${{ secrets.SPRING_SECRET_URL }}
EOF

            docker pull ${{ secrets.DOCKER_USER_NAME }}/${{ secrets.DOCKER_IMAGE_NAME }}
            docker-compose down
            docker-compose --env-file .env up -d --build
